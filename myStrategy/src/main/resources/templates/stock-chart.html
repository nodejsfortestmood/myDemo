<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票K线图</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
        }

        .stock-info {
            display: flex;
            align-items: baseline;
            gap: 15px;
        }

        .stock-code {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stock-name {
            font-size: 18px;
            color: #7f8c8d;
        }

        .price-info {
            text-align: right;
        }

        .current-price {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .price-change {
            font-size: 16px;
            font-weight: 300;
        }

        .positive {
            color: #f44336;
        }

        .negative {
            color: #4CAF50;
        }

        .toolbar {
            display: flex;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 8px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background: #f0f0f0;
        }

        .toolbar-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        #chart-container {
            padding: 20px;
            position: relative;
        }

        #chart {
            width: 100%;
            height: 600px;
        }

        .chart-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .back-btn {
            display: inline-block;
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            margin: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .price-info {
                text-align: left;
                width: 100%;
            }

            #chart {
                height: 500px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- 头部信息 -->
    <div class="header">
        <div class="stock-info">
            <div class="stock-code" id="stockCode">--</div>
            <div class="stock-name" id="stockName">--</div>
        </div>
        <div class="price-info">
            <div class="current-price" id="currentPrice">--</div>
            <div class="price-change" id="priceChange">--</div>
        </div>
    </div>

    <!-- 工具栏 -->
    <div class="toolbar">
        <button class="toolbar-btn" data-days="30">近1月</button>
        <button class="toolbar-btn" data-days="60">近2月</button>
        <button class="toolbar-btn active" data-days="90">近3月</button>
        <button class="toolbar-btn" data-days="180">近6月</button>
        <button class="toolbar-btn" data-days="365">近1年</button>
        <button class="toolbar-btn" data-days="0">全部数据</button>
    </div>

    <!-- K线图容器 -->
    <div id="chart-container">
        <div id="chart"></div>
        <div class="chart-loading" id="chartLoading" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <div style="text-align: center;">
        <a href="javascript:history.back()" class="back-btn">返回列表</a>
    </div>
</div>

<script>
    // 全局变量
    const urlParams = new URLSearchParams(window.location.search);
    const stockCode = urlParams.get('code') || '';
    let stockName = urlParams.get('name') || '';
    let chart = null;
    let currentDays = 30;

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        // 设置股票基本信息
        document.getElementById('stockCode').textContent = stockCode;
        document.getElementById('stockName').textContent = stockName || `${stockCode}股票`;

        // 如果没有股票名称，尝试从后端获取
        if (!stockName) {
            fetchStockBasicInfo();
        }

        // 初始化图表
        initChart();

        // 加载初始数据
        loadStockData(currentDays);

        // 绑定工具栏按钮事件
        document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // 更新按钮状态
                document.querySelectorAll('.toolbar-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // 获取天数参数
                currentDays = parseInt(this.getAttribute('data-days'));

                // 加载数据
                loadStockData(currentDays);
            });
        });

        // 窗口大小变化时重绘图表
        window.addEventListener('resize', function() {
            if (chart) {
                chart.resize();
            }
        });
    });

    // 获取股票基本信息
    function fetchStockBasicInfo() {
        fetch(`/api/stock/basic/${stockCode}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.stockName) {
                    stockName = data.stockName;
                    document.getElementById('stockName').textContent = stockName;
                }
            })
            .catch(error => console.error('获取股票信息失败:', error));
    }

    // 初始化ECharts图表
    function initChart() {
        chart = echarts.init(document.getElementById('chart'));

        // 初始空配置
        chart.setOption({
            animation: false,
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            legend: {
                data: ['K线', '成交量', 'MA5', 'MA10', 'MA20'],
                selected: {
                    'MA5': true,
                    'MA10': true,
                    'MA20': true
                }
            },
            grid: [
                {
                    left: '10%',
                    right: '10%',
                    top: '10%',
                    height: '50%'  // K线图区域高度
                },
                {
                    left: '10%',
                    right: '10%',
                    top: '65%',
                    height: '20%'   // 成交量区域高度
                }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: [],
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax',
                    gridIndex: 0
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: [],
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    axisTick: { show: false },
                    splitLine: { show: false },
                    axisLabel: { show: false },
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax'
                }
            ],
            yAxis: [
                {
                    scale: true,
                    gridIndex: 0,
                    splitArea: {
                        show: true
                    }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: 0,
                    end: 100
                },
                {
                    show: true,
                    xAxisIndex: [0, 1],
                    type: 'slider',
                    bottom: '5%',
                    start: 0,
                    end: 100
                }
            ],
            series: [
                {
                    name: 'K线',
                    type: 'candlestick',
                    data: [],
                    itemStyle: {
                        color: '#f44336',
                        color0: '#4CAF50',
                        borderColor: '#f44336',
                        borderColor0: '#4CAF50'
                    },
                    xAxisIndex: 0,
                    yAxisIndex: 0
                },
                {
                    name: '成交量',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: [],
                    itemStyle: {
                        color: function(params) {
                            // 根据涨跌显示不同颜色
                            const data = chart.getOption().series[0].data;
                            if (data && data[params.dataIndex]) {
                                const item = data[params.dataIndex];
                                return item[1] >= item[0] ? '#f44336' : '#4CAF50';
                            }
                            return '#5470C6';
                        }
                    },
                    barWidth: '60%'
                }
            ]
        });
    }

    // 加载股票数据
    function loadStockData(days) {
        showLoading();

        // 获取K线数据
        fetch(`/api/stock/kline?code=${stockCode}&days=${days}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应异常');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    // 更新股票基本信息
                    updateStockInfo(data[data.length-1]);

                    // 渲染K线图
                    renderChart(data);
                } else {
                    console.log('暂无数据');
                }
            })
            .catch(error => {
                console.error('加载数据失败:', error);
            })
            .finally(() => {
                hideLoading();
            });
    }

    // 更新股票基本信息
    function updateStockInfo(latestData) {
        const currentPrice = latestData.closePrice;
        const percent = latestData.percent;

        document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
        const changeElement = document.getElementById('priceChange');
        changeElement.textContent = (percent >= 0 ? '+' : '') + percent.toFixed(2) + '%';
        changeElement.className = percent >= 0 ? 'price-change positive' : 'price-change negative';
    }

    // 渲染K线图
    function renderChart(data) {
        const dates = data.map(item => item.date);
        const values = data.map(item => [
            item.open,
            item.closePrice,
            item.low,
            item.high
        ]);
        const volumes = data.map(item => item.volume);

        // 提取MA5、MA10、MA20数据
        const ma5 = data.map(item => item.ma5 || null);
        const ma10 = data.map(item => item.ma10 || null);
        const ma20 = data.map(item => item.ma20 || null);

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function(params) {
                    const item = data[params[0].dataIndex];
                    const last = data[data.length-1];
                    const days = data.length-params[0].dataIndex;
                    const diff = last.closePrice - item.closePrice;
                    const rate = ((diff / item.closePrice) * 100).toFixed(2);
                    const rateColor = rate > 0 ? '#f44336' : '#4CAF50';
                    const sign = rate >= 0 ? '+' : '';
                    const color = item.closePrice >= item.open ? '#f44336' : '#4CAF50';
                    return `
                        <div style="font-size:16px;font-weight:bold;margin-bottom:10px;color:#333;">
                            ${item.date} ${stockName || stockCode}
                        </div>
                        <div style="display:flex;justify-content:space-between;width:220px;">
                            <div style="text-align:left;">
                                <div>开盘: ${item.open.toFixed(2)}</div>
                                <div>收盘: ${item.closePrice.toFixed(2)}</div>
                                <div>最高: ${item.high.toFixed(2)}</div>
                                <div>最低: ${item.low.toFixed(2)}</div>
                                <div>${days}天涨幅:
                                <span style="color:${rateColor}">
                                ${sign}${rate}%</span></div>
                            </div>
                            <div style="text-align:right;">
                                <div>涨跌: <span style="color:${color}">
                                    ${(item.percent >= 0 ? '+' : '') + item.percent.toFixed(2)}%
                                </span></div>
                                <div>成交量: ${formatVolume(item.volume)}</div>
                                <div>成交额: ${formatAmount(item.amount)}</div>
                            </div>
                        </div>
                    `;
                }
            },
            xAxis: [
                {
                    data: dates,
                    axisLabel: {
                        formatter: function(value) {
                            const date = new Date(value);
                            return `${date.getMonth()+1}/${date.getDate()}`;
                        }
                    }
                },
                {
                    data: dates
                }
            ],
            series: [
                {
                    data: values
                },
                {
                    data: volumes
                },
                // MA5均线
                {
                    name: 'MA5',
                    type: 'line',
                    data: ma5,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: '#FF7F50'
                    },
                    symbol: 'none',
                    xAxisIndex: 0,
                    yAxisIndex: 0
                },
                // MA10均线
                {
                    name: 'MA10',
                    type: 'line',
                    data: ma10,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: '#6A5ACD'
                    },
                    symbol: 'none',
                    xAxisIndex: 0,
                    yAxisIndex: 0
                },
                // MA20均线
                {
                    name: 'MA20',
                    type: 'line',
                    data: ma20,
                    smooth: true,
                    lineStyle: {
                        width: 1,
                        color: '#20B2AA'
                    },
                    symbol: 'none',
                    xAxisIndex: 0,
                    yAxisIndex: 0
                }
            ]
        };

        chart.setOption(option);
    }

    // 格式化成交量
    function formatVolume(volume) {
        if (volume >= 1000000) {
            return (volume / 1000000).toFixed(2) + '万手';
        } else if (volume >= 10000) {
            return (volume / 10000).toFixed(2) + '万手';
        }
        return volume.toFixed(0) + '手';
    }

    // 格式化成交额
    function formatAmount(amount) {
        if (amount >= 100000000) {
            return (amount / 100000000).toFixed(2) + '亿';
        } else if (amount >= 10000) {
            return (amount / 10000).toFixed(2) + '万';
        }
        return amount.toFixed(2);
    }

    // 显示加载状态
    function showLoading() {
        document.getElementById('chartLoading').style.display = 'flex';
    }

    // 隐藏加载状态
    function hideLoading() {
        document.getElementById('chartLoading').style.display = 'none';
    }
</script>
</body>
</html>